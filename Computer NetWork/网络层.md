- [网络层功能和提供的服务](#网络层功能和提供的服务)
  - [网络层提供的功能](#网络层提供的功能)
  - [比较网络层和传输层提供的服务](#比较网络层和传输层提供的服务)
  - [有了网络层为什么还要设置传输层？](#有了网络层为什么还要设置传输层)
- [IP数据报格式](#ip数据报格式)
  - [IPv4](#ipv4)
  - [IPv6](#ipv6)
- [IP地址编址方式](#ip地址编址方式)
  - [分类编址](#分类编址)
  - [子网划分](#子网划分)
  - [CIDR](#cidr)
- [网络地址转换NAT](#网络地址转换nat)
- [网际控制报文协议 ICMP](#网际控制报文协议-icmp)
  - [Ping](#ping)
  - [Traceroute](#traceroute)
- [自治系统、层次选路](#自治系统层次选路)
  - [域（自治系统）内路由选择](#域自治系统内路由选择)
    - [内部网关协议 RIP](#内部网关协议-rip)
    - [内部网关协议 OSPF](#内部网关协议-ospf)
  - [域间路由选择协议BGP](#域间路由选择协议bgp)
  - [层次选路优点](#层次选路优点)
  - [为什么AS内选路和AS间选路采用不同的协议？](#为什么as内选路和as间选路采用不同的协议)



![image-20200905195026546](https://kay-rick.oss-cn-beijing.aliyuncs.com/img/20200905195028.png)



## 网络层功能和提供的服务



### 网络层提供的功能

- **转发**：将分组从路由器的一个输入链路接口转移到一个合适的输出链路接口（本地动作，只涉及分组在路由器中从入链路到出链路的传送）
- **选路**：指分组从源到目的地的端到端路径的网络范围动作。（涉及网络中所有路由器，集体经选路协议交互）



### 比较网络层和传输层提供的服务

- **服务对象不同：网络层向运输层提供的主机到主机的服务；运输层向应用层提供的进程到进程的服务**。

- **服务选择不同**：任何网络中的网络层只提供虚电路网络和数据报网络两种服务之一，不会同时提供；运输层所提供的服务会同时提供，由应用层应用根据需要选择。

- **实现不同**：运输层面向连接服务在网络边缘的端系统中实；网络层**面向连接服务在端系统及网络核心的路由器中实现**



### 有了网络层为什么还要设置传输层？

- 两个主机进行通信**实际上是两个主机中的应用进程通信**。一个主机中经常有多个应用进程同时分别与另外一个主机中的多个应用进程互相通信。**网络层协议能够将分组送达目的主机，但它无法交付给主机中的应用程序**
- **传输层对整个报文段进行差错校验和检测**，因为IP数据报每经过一个路由器都要重新计算校验和，为了提高传输效率，**IP首部中的首部校验和字段只检测首部是否出现差错而不检查数据部分**。传输层TCP和UDP的校验和既要校验首部也要校验数据部分，并且只在发送端进行一次校验和计算，在接受端进行一次校验
- 根据应用的不同，传输层需要执行不同的传输协议来提供不同的传输服务
- **传输层的存在使得传输层服务比网络服务更加有效合理**，网络层是通信子网的组成部分，用户不能对通信子网加以控制，无法解决网络层的服务质量不佳问题，也不可能通过改进数据链路层纠错能力来改善低层条件



## IP数据报格式



### IPv4

<div align = "center"><img src = "https://kay-rick.oss-cn-beijing.aliyuncs.com/img/20200905104531.png" width = "800" height = "400"></img></div>

- **版本** : 有 4（IPv4）和 6（IPv6）两个值；
- **首部长度** : 占 4 位，因此最大值为 15。值为 1 表示的是 1 个 32 位字的长度，也就是 4 字节。因为固定部分长度为 20 字节，因此该值最小为 5。如果可选字段的长度不是 4 字节的整数倍，就用尾部的填充部分来填充。
- **服务类型** : 用来获得更好的服务，区分不同类型的IP数据报（例如，一些特别要求低延迟、高吞吐量或可靠性的数据报）
- **长度** : 包括首部长度和数据部分长度。
- **寿命** ：TTL，它的存在是为了防止无法交付的数据报在互联网中不断兜圈子。以路由器跳数为单位，当 TTL 为 0 时就丢弃数据报。
- **协议** ：指出携带的数据应该上交给哪个协议进行处理，例如 ICMP、TCP、UDP 等。
- **首部检验和** ：因为**数据报每经过一个路由器，都要重新计算检验和**，因此检验和不包含数据部分可以减少计算的工作量。
- **标识** : 在数据报长度过长从而发生分片的情况下，相同数据报的不同分片具有相同的标识符。
- **片偏移** : 和标识符一起，用于发生分片的情况。片偏移的单位为 8 字节。



**数据报分片：**

<div align = "center"><img src = "https://kay-rick.oss-cn-beijing.aliyuncs.com/img/20200905105050.png" width = "750" height = "300"></img></div>



### IPv6

<div align = "center"><img src = "https://kay-rick.oss-cn-beijing.aliyuncs.com/img/20200905110056.png" width = "600" height = "400"></img></div>



- **版本**：有 4（IPv4）和 6（IPv6）两个值；

- **流量类型**：同IPv4的服务类型含义

- **流标签**：能够对一条流中的某些数据报给出优先权，或者能够用来对来自某些应用的数据报给出更高优先权

- **有效载荷长度**：首部定长40bit，该字段记录了首部后面的字节数量

- **下一个首部**：**表示数据报中的内容交付给哪个协议（TCP or UDP）**

- **跳限制**：转发数据报的每台路由器将对该字段进行减1，如果跳限技术达到了0，则该数据报将被丢弃

  



## IP地址编址方式



### 分类编址

<div align = "center"><img src = "https://kay-rick.oss-cn-beijing.aliyuncs.com/img/20200905152246.png" width = "650" height = "400"></img></div>

- 由两部分组成，网络号和主机号，其中不同分类具有不同的网络号长度，并且是固定的。
- A类地址**利用IP地址的第一个字节作为网络地址，最高位为0**，其余的三个字节作为主机地址，地址范围为1. 0. 0. 1~127.255.255.254
- B类地址l**利用IP地址的前两个字节作为网络地址，最高位为10**，其余的两个字节作为主机地址，地址范围为128.0.0.1~191.255.255.254
- C类地址**利用IP地址的前三个字节作为网络地址，最高位为110**，最后一个字节作为主机地址，地址范围为192.0.0.1~223.255.255.254 
- 本地地址：本地地址127.0.0.1-127.255.255.254。这是预留的一组IP地址，主要是用来识别主机本身的地址。也叫做“localhost”，一般用来测试
- 私有地址（Private address）10.x.x.x, 172.16.x.x-172.31.x.x,  192.168.x.x 。这三个地址段被称为私有IP地址段，也就是局域网所使用的地址段，在公网上不能被路由
- 0.0.0.0：这个地址严格上来说都不是真正意义上的IP地址。主要是用来标识不清楚的网络和主机的。系统遇到无法识别的网络或主机的时候会统一的归纳到这个地址
- 255.255.255.255：这个地址是受限的广播地址。主要指一个网段内的所有主机



### 子网划分

<div align = "center"><img src = "https://kay-rick.oss-cn-beijing.aliyuncs.com/img/20200905153419.png" width = "500" height = "350"></img></div>

- 网络号相同的IP地址属于同一个网络。而网络还可以划分为若干子网（subnet）
- 划分子网的方法是从主机号借用若干个比特作为子网号，剩下的主机位为主机号
- 子网掩码用来确定网络地址（包括网络号和子网号）和主机地址的长度。子网掩码长为32位比特，其中的1对应于IP地址中的网络号和子网号，而子网掩码中的0对应于主机号。**（外部网络看不到子网的存在）**



### CIDR

**引入原因：**

> 传统分类编址的方法导致了地址的大量浪费

使用斜线记法，又称为CIDR记法来区分网络前缀和主机号，**即在IP地址后面加上一个斜线“/”，斜线后面用一个数字指定网络前缀的长度**

例如 128.14.35.7/20 表示前 20 位为网络前缀

一个 CIDR 地址块中有很多地址，一个 CIDR 表示的网络就可以表示原来的很多个网络，并且在路由表中只需要一个路由就可以代替原来的多个路由，减少了路由表项的数量。把这种通过使用网络前缀来减少路由表项的方式称为路由聚合，也称为 **构成超网** 。



## 网络地址转换NAT



**对外部网络来讲，本地网络只用一个IP地址**；不需要从 ISP分配一系列地址—— 只要一个IP地址用于所有设备；**在本地网络，改变设备的IP地址不用通知外部世界**；可以变更 ISP ，不用改变本地网络的设备的地址；本地网络内部设备不能被外部世界明确寻址，或是不可见 (增加了安全性)

<div align = "center"><img src = "https://kay-rick.oss-cn-beijing.aliyuncs.com/img/20200905193958.png" width = "800" height = "400"></img></div>



## 网际控制报文协议 ICMP

ICMP 是为了更有效地转发 IP 数据报和提高交付成功的机会。**它封装在 IP 数据报中，但是不属于高层协议**。

<div align = "center"><img src = "https://kay-rick.oss-cn-beijing.aliyuncs.com/img/20200905161905.png" width = "700" height = "400"></img></div>

ICMP 报文分为**差错报告报文和询问报文**

| 类型 | 代码 |         描述         |
| :--: | :--: | :------------------: |
|  0   |  0   |       ping应答       |
|  3   |  0   |   目的网络不可到达   |
|  3   |  1   |   目的主机不可到达   |
|  3   |  2   |   目的协议不可到达   |
|  3   |  3   |   目的端口不可到达   |
|  3   |  6   |   不知道的目的网络   |
|  3   |  7   |   不知道的目的主机   |
|  4   |  0   | 源端抑制（拥塞控制） |
|  8   |  0   |       ping请求       |
|  9   |  0   |      路由器公告      |
|  10  |  0   |      路由器发现      |
|  11  |  0   |       TTL过期        |
|  12  |  0   |      IP首部损坏      |



### Ping

Ping 是 ICMP 的一个重要应用，主要用来**测试两台主机之间的连通性**。

Ping 的原理是通过**向目的主机发送 ICMP Echo 请求报文，目的主机收到之后会发送 Echo 回答报文。Ping 会根据时间和成功响应的次数估算出数据包往返时间以及丢包率**。



### Traceroute

Traceroute 是 ICMP 的另一个应用，用来跟踪一个分组从源点到终点的路径。

**Traceroute发送的IP数据报封装的是无法交付的UDP用户数据报**，并由目的主机发送终点不可达差错报告报文。

- 源主机向目的主机**发送一连串的 IP 数据报**。第一个数据报 P1 的生存时间 TTL 设置为 1，当 P1 到达路径上的第一个路由器 R1 时，R1 收下它并把 TTL减1，此时 TTL等于0，R1就把P1丢弃，并向源主机发送一个 ICMP 时间超过差错报告报文；
- 源主机接着发送第二个数据报 P2，并把 TTL 设置为 2。P2 先到达 R1，R1 收下后把 TTL 减 1 再转发给 R2，R2 收下后也把 TTL 减 1，由于此时 TTL 等于 0，R2 就丢弃 P2，并向源主机发送一个 ICMP 时间超过差错报文。
- **不断执行这样的步骤，直到最后一个数据报刚刚到达目的主机，主机不转发数据报，也不把 TTL 值减 1**。但是因为数据报封装的是无法交付的 UDP，因此目的主机要向源主机发送 ICMP 终点不可达差错报告报文。
- 之后源主机知道了到达目的主机所经过的路由器 IP 地址以及到达每个路由器的往返时间。



## 自治系统、层次选路

**自治系统(Autonomous System)AS**：按区域划分的系统。每个AS由一组在相同管理控制下的路由器组成。同一个AS内的路由器可运行相同的选路算法

**层次选路**：将一个大的系统划分成若干小系统(自治系统)，按区域或自治系统的形式组织路由器。自治系统之间再互连。在一个自治系统内运行自治系统内部选路协议，在各AS之间运行自治系统之间的选路协议

**网关路由器**：和其他自治系统内的路由器直接相连的路由器，**运行域间路由协议**，与其他网关路由器交互。同自治系统内的所有其他路由器一样**也运行域内路由协议**

**路由选择协议**：自适应，能随着网络通信量和拓扑结构的变化而自适应地进行调整。

可以把路由选择协议划分为两大类：

- 自治系统内部的路由选择：RIP 和 OSPF
- 自治系统间的路由选择：BGP



<div align = "center"><img src = "https://kay-rick.oss-cn-beijing.aliyuncs.com/img/20200905184814.png" width = "550" height = "400"></img></div>



### 域（自治系统）内路由选择



#### 内部网关协议 RIP

RIP 是一种**基于距离向量的路由选择协议**。距离是指跳数，直接相连的路由器跳数为 1。跳数最多为 15，超过 15 表示不可达。

RIP **按固定的时间间隔仅和相邻路由器交换自己的路由表**，经过若干次交换之后，所有路由器最终会知道到达本自治系统中任何一个网络的最短距离和下一跳路由器地址。

距离向量算法：

- 对地址为 X 的相邻路由器发来的 RIP 报文，先修改报文中的所有项目，把下一跳字段中的地址改为 X，并把所有的距离字段加 1；
- 对修改后的 RIP 报文中的每一个项目，进行以下步骤：
- 若原来的路由表中没有目的网络 N，则把该项目添加到路由表中；
- 否则：若下一跳路由器地址是 X，则把收到的项目替换原来路由表中的项目；否则：若收到的项目中的距离 d 小于路由表中的距离，则进行更新（例如原始路由表项为 Net2, 5, P，新表项为 Net2, 4, X，则更新）；否则什么也不做。
- 若 3 分钟还没有收到相邻路由器的更新路由表，则把该相邻路由器标为不可达，即把距离置为 16。

**优点**：实现简单、开销小

**缺点**：RIP能使用的最大距离为15，**限制了网络的规模**。而且**坏消息传递慢**（当网络出现故障时，要经过比较长的时间才能将此消息传送到所有路由器）



#### 内部网关协议 OSPF

开放最短路径优先 OSPF，是为了**克服 RIP 的缺点而开发出来**的。

开放表示 OSPF 不受某一家厂商控制，而是公开发表的；最短路径优先表示**使用了 Dijkstra 提出的最短路径算法** SPF。

OSPF 具有以下特点：

- 向本自治系统中的**所有路由器发送信息**，这种方法是洪泛法。
- 发送的信息就是与相邻路由器的链路状态，链路状态包括与哪些路由器相连以及链路的度量，度量用费用、距离、时延、带宽等来表示。
- 只有当链路状态发生变化时，路由器才会发送信息。

所有路由器都具有全网的拓扑结构图，并且是一致的。相比于 RIP，OSPF 的更新过程收敛的很快。

**优点**：安全、允许多条相同开销的路径、对单播与多播路由选择的综合支持、支持在单个AS中的层次结构



### 域间路由选择协议BGP

BGP（Border Gateway Protocol，边界网关协议）

AS 之间的路由选择很困难，主要是由于：

- 互联网规模很大；
- 各个 AS 内部使用不同的路由选择协议，无法准确定义路径的度量；
- AS 之间的路由选择必须考虑有关的策略，比如有些 AS 不愿意让其它 AS 经过。

**BGP 只能寻找一条比较好的路由，而不是最佳路由**

**每个 AS 都必须配置 BGP 发言人，通过在两个相邻 BGP 发言人之间建立 TCP 连接来交换路由信息**



<div align = "center"><img src = "https://kay-rick.oss-cn-beijing.aliyuncs.com/img/20200905191923.png" width = "550" height = "300"></img></div>

- **eBGP**：跨越两个AS的BGP连接成为外部BGP（eBGP）
- **iBGP**：相同AS中的两台路由器之间的BGP会话称为内部BGP（iBGP）
- 在3a和1c的eBGP会话中，AS3向AS1通告一个前缀可达信息。1c通过iBGP会话向AS1中的所有路由器发布这个新的前缀可达信息。1b 又将这个可达信息通过1b和2a之间的eBGP会话通告给AS2。当路由器得知一个新的前缀时，就在它的转发表中为该前缀创建一个项。



### 层次选路优点

- **减少规模大的网络选路计算的复杂性**：AS内部路由器运行相同的自治系统内部选路协议，仅需要知道本AS内的路由器与网关路由器。各AS之间，运行相同的AS间选路协议。
- **管理职权灵活**：一个**组织可自行选择AS内部选路协议**，每对相连的AS运行相同AS间选路协议，交换信息



### 为什么AS内选路和AS间选路采用不同的协议？

- **策略**：AS间管理员想控制本AS内产生的通信流怎样选路，以及什么通信流穿过自己的网络；AS内单个管理者， 因此不需要策略
- **规模**：层次路由节省了转发表的大小空间，减少了路由更新的流量
- **性能**：AS内集中在性能上；AS间策略可能比性能更加重要



